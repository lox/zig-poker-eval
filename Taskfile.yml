---

version: '3'

vars:
  ZIG_OPTIMIZE: '{{.ZIG_OPTIMIZE | default "ReleaseFast"}}'
  # Tests default to Debug for better error detection (assertions, bounds checks)
  ZIG_TEST_OPTIMIZE: '{{.ZIG_TEST_OPTIMIZE | default "Debug"}}'

tasks:
  build:
    desc: Build poker-eval CLI executable
    cmds:
      - zig build -Doptimize={{.ZIG_OPTIMIZE}}
    sources:
      - src/**/*.zig
      - build.zig
    generates:
      - zig-out/bin/poker-eval

  test:
    desc: Run all unit tests (defaults to Debug)
    cmds:
      - zig build test -Doptimize={{.ZIG_TEST_OPTIMIZE}} --summary all

  bench:
    desc: Run poker evaluator benchmarks
    deps:
      - build
    cmds:
      - zig-out/bin/poker-eval bench {{.CLI_ARGS}}

  bench:eval:
    desc: Benchmark hand evaluation performance
    deps:
      - build
    cmds:
      - zig-out/bin/poker-eval bench {{.CLI_ARGS}}

  bench:equity:
    desc: Benchmark Monte Carlo equity calculation performance
    deps:
      - build
    cmds:
      - zig-out/bin/poker-eval bench --equity {{.CLI_ARGS}}

  bench:showdown:
    desc: Benchmark showdown evaluation (scalar vs batched)
    deps:
      - build
    cmds:
      - zig-out/bin/poker-eval bench --showdown {{.CLI_ARGS}}

  run:
    desc: Run poker-eval CLI with optional arguments
    deps:
      - build
    cmds:
      - zig-out/bin/poker-eval {{.CLI_ARGS}}

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf zig-out zig-cache

  profile:eval:
    desc: Profile hand evaluation with uniprof (default 20M iterations, ReleaseFast)
    vars:
      ITERATIONS: '{{.ITERATIONS | default "20000000"}}'
      PROFILE_DIR: '{{.PROFILE_DIR | default "/tmp/eval_profile"}}'
      PROFILE_JSON: '{{.PROFILE_DIR}}/profile.json'
    sources:
      - src/**/*.zig
      - build.zig
    generates:
      - '{{.PROFILE_JSON}}'
    cmds:
      - zig build -Doptimize=ReleaseFast
      - rm -rf "{{.PROFILE_DIR}}"
      - mkdir -p "{{.PROFILE_DIR}}"
      - command -v dsymutil >/dev/null 2>&1 && dsymutil zig-out/bin/poker-eval || true
      - uniprof record --platform native -o "{{.PROFILE_JSON}}" -- zig-out/bin/poker-eval bench --iterations={{.ITERATIONS}}

  profile:equity:
    desc: Profile equity calculations with uniprof (ReleaseFast)
    vars:
      PROFILE_DIR: '{{.PROFILE_DIR | default "/tmp/equity_profile"}}'
      PROFILE_JSON: '{{.PROFILE_DIR}}/profile.json'
    sources:
      - src/**/*.zig
      - build.zig
    generates:
      - '{{.PROFILE_JSON}}'
    cmds:
      - zig build -Doptimize=ReleaseFast
      - rm -rf "{{.PROFILE_DIR}}"
      - mkdir -p "{{.PROFILE_DIR}}"
      - command -v dsymutil >/dev/null 2>&1 && dsymutil zig-out/bin/poker-eval || true
      - uniprof record --platform native -o "{{.PROFILE_JSON}}" -- zig-out/bin/poker-eval bench --equity

  profile:showdown:
    desc: Profile showdown evaluation with uniprof (ReleaseFast)
    vars:
      PROFILE_DIR: '{{.PROFILE_DIR | default "/tmp/showdown_profile"}}'
      PROFILE_JSON: '{{.PROFILE_DIR}}/profile.json'
    sources:
      - src/**/*.zig
      - build.zig
    generates:
      - '{{.PROFILE_JSON}}'
    cmds:
      - zig build -Doptimize=ReleaseFast
      - rm -rf "{{.PROFILE_DIR}}"
      - mkdir -p "{{.PROFILE_DIR}}"
      - command -v dsymutil >/dev/null 2>&1 && dsymutil zig-out/bin/poker-eval || true
      - uniprof record --platform native -o "{{.PROFILE_JSON}}" -- zig-out/bin/poker-eval bench --showdown

  profile:aragorn:initBoard:
    desc: Profile initBoardContext (aragorn hot path)
    vars:
      ITERATIONS: '{{.ITERATIONS | default "50000000"}}'
      PROFILE_DIR: '{{.PROFILE_DIR | default "/tmp/aragorn_initboard_profile"}}'
      PROFILE_JSON: '{{.PROFILE_DIR}}/profile.json'
    sources:
      - src/**/*.zig
      - build.zig
    generates:
      - '{{.PROFILE_JSON}}'
    cmds:
      - zig build -Doptimize=ReleaseFast
      - rm -rf "{{.PROFILE_DIR}}"
      - mkdir -p "{{.PROFILE_DIR}}"
      - command -v dsymutil >/dev/null 2>&1 && dsymutil zig-out/bin/profile_aragorn || true
      - uniprof record --platform native -o "{{.PROFILE_JSON}}" -- zig-out/bin/profile_aragorn initBoard {{.ITERATIONS}}

  profile:aragorn:showdown:
    desc: Profile evaluateShowdownWithContext (aragorn hot path)
    vars:
      ITERATIONS: '{{.ITERATIONS | default "50000000"}}'
      PROFILE_DIR: '{{.PROFILE_DIR | default "/tmp/aragorn_showdown_profile"}}'
      PROFILE_JSON: '{{.PROFILE_DIR}}/profile.json'
    sources:
      - src/**/*.zig
      - build.zig
    generates:
      - '{{.PROFILE_JSON}}'
    cmds:
      - zig build -Doptimize=ReleaseFast
      - rm -rf "{{.PROFILE_DIR}}"
      - mkdir -p "{{.PROFILE_DIR}}"
      - command -v dsymutil >/dev/null 2>&1 && dsymutil zig-out/bin/profile_aragorn || true
      - uniprof record --platform native -o "{{.PROFILE_JSON}}" -- zig-out/bin/profile_aragorn showdown {{.ITERATIONS}}

  profile:aragorn:multiway:
    desc: Profile evaluateHand (aragorn multiway equity path)
    vars:
      ITERATIONS: '{{.ITERATIONS | default "50000000"}}'
      PROFILE_DIR: '{{.PROFILE_DIR | default "/tmp/aragorn_multiway_profile"}}'
      PROFILE_JSON: '{{.PROFILE_DIR}}/profile.json'
    sources:
      - src/**/*.zig
      - build.zig
    generates:
      - '{{.PROFILE_JSON}}'
    cmds:
      - zig build -Doptimize=ReleaseFast
      - rm -rf "{{.PROFILE_DIR}}"
      - mkdir -p "{{.PROFILE_DIR}}"
      - command -v dsymutil >/dev/null 2>&1 && dsymutil zig-out/bin/profile_aragorn || true
      - uniprof record --platform native -o "{{.PROFILE_JSON}}" -- zig-out/bin/profile_aragorn multiway {{.ITERATIONS}}

  gen:all-hands:
    desc: Generate all 133M hand evaluations to binary file
    sources:
      - src/**/*.zig
      - build.zig
    generates:
      - all_hands.dat
    cmds:
      - zig build gen-all -Doptimize={{.ZIG_OPTIMIZE}}

  verify:all-hands:
    desc: Verify evaluator against all 133M hands
    deps:
      - gen:all-hands
    sources:
      - src/**/*.zig
      - build.zig
      - all_hands.dat
    cmds:
      - zig build verify-all -Doptimize={{.ZIG_OPTIMIZE}}

  gen:heads-up:
    desc: Generate heads-up equity tables (~15 min)
    sources:
      - src/**/*.zig
      - build.zig
    generates:
      - src/heads_up_tables.zig
    cmds:
      - zig build gen-heads-up -Doptimize={{.ZIG_OPTIMIZE}}

  gen:heads-up-matrix:
    desc: Generate 169x169 heads-up equity matrix (~20 min)
    sources:
      - src/**/*.zig
      - build.zig
    generates:
      - src/heads_up_matrix.zig
    cmds:
      - zig build gen-heads-up-matrix -Doptimize={{.ZIG_OPTIMIZE}}

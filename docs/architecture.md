<!-- Generated: 2025-07-09 07:24:48 UTC -->

# Zig Poker Evaluator Architecture

## Overview

The Zig poker evaluator is a high-performance 7-card poker hand evaluation library designed to achieve 2-5 nanoseconds per hand evaluation on modern CPUs. The system leverages perfect hash functions (CHD - Compress, Hash & Displace), SIMD vectorization, and carefully optimized data structures to achieve near-optimal performance. The architecture is modular, separating the core evaluation engine from supporting functionality like equity calculations, range parsing, and board analysis.

The evaluator employs a two-phase approach: first detecting flush hands through bit manipulation on suit masks, then using a perfect hash function to map rank patterns to hand strengths. This dual-path strategy minimizes memory accesses while maintaining perfect accuracy. The system includes both scalar and SIMD-optimized implementations, with batch processing capabilities that can evaluate 32 hands simultaneously at approximately 4.1ns per hand.

The codebase emphasizes compile-time optimization and zero-cost abstractions, utilizing Zig's comptime features to generate efficient code paths. Memory usage is kept minimal at ~120KB total, making the evaluator cache-friendly and suitable for high-frequency trading or poker AI applications requiring millions of evaluations per second.

## Component Map

```
┌─────────────────────────────────────────────────────────────────┐
│                         Public API Layer                         │
│  src/poker.zig - Main entry point and API exports              │
└─────────────────────────────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┴──────────────────────────┐
        │                                                      │
┌───────▼────────────┐                            ┌───────────▼──────────┐
│  Core Evaluation   │                            │  Game Components     │
├────────────────────┤                            ├──────────────────────┤
│ src/evaluator.zig  │                            │ src/card.zig         │
│ - Scalar eval      │                            │ src/hand.zig         │
│ - SIMD batch       │                            │ src/range.zig        │
│ - RPC computation  │                            │ src/equity.zig       │
│ - Flush detection  │                            │ src/analysis.zig     │
└──────────┬─────────┘                            │ src/draws.zig        │
           │                                      └──────────────────────┘
           │
┌──────────▼─────────────────────────────────┐
│          Internal Components               │
├────────────────────────────────────────────┤
│ src/internal/tables.zig - Lookup tables   │
│ src/internal/mphf.zig - Perfect hashing   │
│ src/internal/slow_evaluator.zig - Ref impl│
│ src/internal/build_tables.zig - Table gen │
└────────────────────────────────────────────┘
```

## Key Files

### Core API
- **src/poker.zig** (lines 1-299): Main public API interface. Exports all public functionality including card creation, hand evaluation, equity calculations, and range parsing. Acts as the single entry point for library users.

### Evaluation Engine
- **src/evaluator.zig** (lines 1-557): Core hand evaluation implementation. Contains both scalar (line 195) and SIMD-optimized (line 207) evaluation functions. Implements RPC (Rank Pattern Computation) algorithm (lines 45-63) and flush detection (lines 132-160).

- **src/internal/tables.zig** (lines 1-16384): Pre-generated perfect hash tables. Contains CHD g_array (displacement table) and value tables for O(1) hand strength lookup. Generated by build_tables.zig.

- **src/internal/mphf.zig** (lines 1-177): Minimal Perfect Hash Function implementation using CHD algorithm. Core lookup function at line 37, hash computation at line 47, and table construction at line 56.

### Game Logic
- **src/card.zig**: Card representation and manipulation. Defines Hand type as u64 bitfield, suit/rank enums, and card creation functions.

- **src/hand.zig**: Hand parsing and combination generation. Includes functions for parsing poker notation, generating suited/offsuit combinations, and pocket pairs.

- **src/equity.zig** (lines 1-500+): Monte Carlo and exact equity calculations. Supports head-to-head (line 137), multi-way (line 151), and detailed statistics tracking.

- **src/range.zig**: Range notation parser and storage. Handles standard poker range syntax like "AA,KK,AKs,AKo".

### Analysis Tools
- **src/analysis.zig**: Board texture analysis including flush/straight potential detection and coordination metrics.

- **src/draws.zig**: Draw detection for identifying flush draws, straight draws, and combo draws.

### Support Tools
- **src/internal/slow_evaluator.zig**: Reference implementation using traditional combinatorial ranking. Used for validation and testing.

- **src/internal/build_tables.zig** (lines 1-500+): Table generation tool. Builds perfect hash tables from all possible hand patterns.

- **src/tools/benchmark.zig**: Performance benchmarking utilities for measuring evaluation speed.

## Data Flow

### Hand Evaluation Flow
```
Input: 7-card hand (u64 bitfield)
           │
           ▼
[evaluator.evaluateHand - line 195]
           │
           ├─► [isFlushHand - line 132] ─Yes─► [getFlushPattern - line 146]
           │                                              │
           │                                              ▼
           │                                    [tables.flushLookup - line 198]
           │                                              │
           ▼                                              │
[computeRpcFromHand - line 45]                           │
           │                                              │
           ▼                                              │
[tables.lookup via CHD - mphf.zig:37]                    │
           │                                              │
           └──────────────────┬───────────────────────────┘
                              ▼
                    Output: HandRank (u16)
```

### Batch Evaluation Flow (SIMD)
```
Input: Vector of hands [@Vector(batchSize, u64)]
           │
           ▼
[evaluator.evaluateBatch - line 207]
           │
           ▼
[computeRpcSimd - line 67] ─── Extract suits to SoA
           │                    (lines 73-83)
           │
           ▼
    Vectorized rank counting
    (lines 93-112)
           │
           ▼
    Per-hand flush check + lookup
    (lines 219-225)
           │
           ▼
Output: @Vector(batchSize, u16)
```

### Perfect Hash Construction (Offline)
```
[build_tables.zig:main - line 14]
           │
           ├─► Generate all non-flush patterns
           │   (49,205 patterns)
           │
           ├─► Generate flush patterns
           │   (1,287 patterns)
           │
           ▼
[mphf.buildChd - line 56]
           │
           ├─► Group patterns by bucket
           │   (lines 78-87)
           │
           ├─► Find displacement for each bucket
           │   (lines 103-131)
           │
           ▼
    Write tables.zig file
    (build_tables.zig:writeTablesFile)
```

### Equity Calculation Flow
```
[equity.monteCarlo - src/equity.zig:137]
           │
           ├─► Deal random community cards
           │
           ├─► Evaluate both hands
           │   (calls evaluator.evaluateHand)
           │
           ├─► Compare hand strengths
           │
           ▼
    Accumulate wins/ties/losses
           │
           ▼
    Return EquityResult struct
```

The architecture achieves its performance goals through careful separation of concerns, aggressive compile-time optimization, and a data layout optimized for both single-hand and batch evaluation scenarios.
